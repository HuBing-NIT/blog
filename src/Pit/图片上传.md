---
title: 图片上传
order: 3
nav:
  title: 踩坑
  path: /blogs
group:
  title: 遇到的坑
  path: /遇到的坑
  order: 2
---

# 3.图片上传

## base64 Str 转换 formData

```javascript
// base64 To FromData
export const BaseTranFromData = (base64Str: string) => {
  function convertBase64UrlToBlob() {
    var bytes = window.atob(base64Str.split(',')[1]);
    //处理异常,将ascii码小于0的转换为大于0
    var ab = new Uint8Array(bytes.length);
    for (var i = 0; i < bytes.length; i++) {
      ab[i] = bytes.charCodeAt(i);
    }
    return new Blob([ab], { type: 'image/jpeg' });
  }
  const formData = new FormData();

  formData.append(
    'uploadFile',
    convertBase64UrlToBlob(),
    `${new Date().getTime()}${createRandomId()}.jpg`,
  );
  return formData;
};
```

## url 地址 转换 FormData

```javascript
export const urlTransBase = (src: string) => {
    const image = new Image();
    image.src = src;
    image.crossOrigin = 'anonymous'; // 处理跨域
    image.onload = function () {
      let canvas = document.createElement('canvas'); // 利用canvas画布
      canvas.width = image.width;
      canvas.height = image.height;
      let ctx = canvas.getContext('2d');
      ctx.drawImage(image, 0, 0, image.width, image.height);
      let base64 = canvas.toDataURL('image/png');
      const formData = BaseTranFromData(base64)
    };
  })
};
```

## 批量上传图片

```javascript
// 利用promise改写url地址 转换 FormData函数
const urlTransBase = (src: string, callback) => {
  // 返回promise对象
  return new Promise((resovle) => {
    const image = new Image();
    image.src = src;
    image.crossOrigin = 'anonymous';
    image.onload = function () {
      let canvas = document.createElement('canvas');
      canvas.width = image.width;
      canvas.height = image.height;
      let ctx = canvas.getContext('2d');
      ctx.drawImage(image, 0, 0, image.width, image.height);
      let base64 = canvas.toDataURL('image/png');
      callback(BaseTranFromData(base64), resovle);
    };
  });
};

const onBatchSumbit = async () => {
  const data = [];
  const promiseArr = []; // 数组项为primise对象

  Array.from(otherIdsMap.values()).map((i) => {
    promiseArr.push(
      urlTransBase(i.src, (formData, reslov) => {
        upFileService.submitFIle(formData).then((res) => {
          // 上传文件接口
          const [e, d] = res;
          if (!e) {
            data.push({
              ...o,
              abstractId: d.id,
            });
            reslov(data);
          }
        });
      }),
    );
    return null;
  });

  new Promise((re) => {
    re(true);
  }).then(() => {
    Promise.all(promiseArr)
      .then(() => {
        // 批量上传成功后
        onBatchSaveCallback(data); // callback逻辑...
      })
      .catch(() => {
        message.error('保存失败');
      })
      .finally(() => {});
  });
};
```
